# 부프로그램 구현

### 호출과 복귀의 일반적 의미

부프로그램 호출과 복구 연산을 부프로그램 연결(subprogram linkage)라 한다.

- 호출 프로그램의 실행 상태 저장
  - 레지스터 값, CPU 상태 비트, 환경 포인터
- 매개변수를 부프로그램에 전달
- 복귀 주소를 부프로그램에 전달
- 제어를 부프로그램에 전달
- 호출은 부프로그램의 비 정적 변수에 대한 기억장소 할당
- 중첩 부프로그램 지원시, 피호출 부프로그램에 가시적인 비지역변수를 접근하는 메커니즘 생성

부프로그램 복귀 연산

- 값-결과-전달의 매개변수가 사용되면, 형식 매개변수의 현재 값을 대응 -> 실 매개변수에 전달
- 부프로그램이 함수이면, 함수 값을 호출자가 이를 받을 수 있는 공간에 전달
- 지역변수에 할당된 기억 공간 해제
- 호출 프로그램의 실행 상태를 복원
- 제어를 호출 프로그램에 반환

단순 부프로그램 구현 순서

1. 단순 부프로그램 구현
2. 스택-동적 지역변수를 갖는 부프로그램 구현
3. 중첩 부프로그램 구현

### 1. 단순 부프로그램 구현

단순 부프로그램의 특성

- 부프로그램은 중첩되지 않는다.
- 모든 지역변수는 정적이다.

호출(call)의 의미

- 호출자의 실행상태를 저장
- 매개변수를 전달
- 복귀 주소를 피호출자에게 전달
- 제어를 피호출자에게 전달

복귀(return)의 의미

- 값-결과-전달의 매개변수가 사용되면, 형식 매개변수의 값이 대응 실 매개변수로 이동
- 부프로그램이 함수이면, 함수 값을 호출자에게 전달
- 호출자의 실행상태를 복원
- 제어를 호출자에게 전달

부프로그램을 수행하고 제어를 호출자에 전달하는데 필요한 완전한 정보 집합

- 호출과 복귀시 저장 정보
  - 호출자 상태 정보
  - 매개변수
  - 복귀주소
  - 함수의 반환 값(부프로그램이 함수인 경우)
- 지역변수
- 부프로그램 코드

단순 부프로그램의 구성

- 변하지 않는 부분: 부프로그램 코드
- 변하는 부분 : 지역변수, 매개변수, 복귀주소 등 비 코드 부분 => 활성화 레코드

활성화 레코드 (AR: activation record)

- 실행중인 부프로그램의 비코드 부분의 형식

활성화 레코드 사례 (ARI: activation record instance)

- 활성화 레코드의 구체적인 예
- 특정 부프로그램 활성화 레코드에 존재하는 데이터의 모임

![](https://github.com/noelvalent/TIL/blob/master/concept_of_programming_language/imgs/190814.png)

프로그램 단위 컴파일시에 외부프로그램 참조 리스트와 함께 기계 코드가 파일로 작성

프로그램이 링커(Linker)에 의해서 통합

링커가 주 프로그램 호출시에, 참조하는 부프로그램 코드와 그 ARI 파일을 찾아서 메모리에 적재하고, 부프로그램 호출의 목적지 주소를 패치(Patch)

### 스택-동적 지역변수를 갖는 부프로그램의 구현 

스택-동적 지역변수를 갖는 부프로그램의 특성

- 스택-동적 지역변수 포함
- 재귀 부프로그램 지원

부프로그램 연셜시 추가 고려사항

- 컴파일러는 지역변수의 묵시적 할당과 해제를 수행하는 코드 생성

- 재귀 함수의 지원
  - 한 부프로그램의 활성화가 동시에 여러 개 존재 가능
  - 한 개의 코드와 여러 개의 ARI 지원

전형적인 활성화 레코드 형식

- 형식은 정해져 있으나 그 크기는 동적 가능
- ARI는 부프로그램이 호출될 때 동적으로 생성된다.
- 복귀주소, 동적링크, 매개변수가 먼저 배치된다.
  - 이러한 항목은 호출자에 의해서 ARI에 저장
  - 지역 변수는 피호출자에 의해서 할당되므로 가장 나중에 배치
  - 복귀주소는 호출자의 해당 호출문 바로 다음 명령어에 대한 포인터

![](https://github.com/noelvalent/TIL/blob/master/concept_of_programming_language/imgs/190814-1.png)

동적 링크 (dynamic link)

- 호출자의 활성화 레코드의 꼭대기에 대한 포인터이다.
- 현재 피호출자의 활성화 레코드를 제거하는데 사용하는데, 스택 꼭대기를 단순히 이전의 동적 링크 값으로 설정하면 된다.
- 동적 링크를 제어 링크(control)라고도 부른다.

활성화 레코드의 저장 위치

- 마지막 호출된 부프로그램이 가장 먼저 종료되므로, 스택이 적합함
- 이러한 스택을 실행시간 스택(run-time stack)이라 한다.

동적 체인 (dynamic chain)

- 주어진 시점에서 스택에 있는 동적 링크들의 집합
- 실행이 현 지점까지 도달한 동적 역사를 반영
- 호출 체인(call chain)이라고도 한다.

지역 오프셋(local offset)

- 활성화 레코드의 시작 지점으로부터 지역변수의 오프셋을 말함
- 지역변수에 대한 지역 오프셋은 컴파일러에 의해서 결정가능
- 지역매개변수의 오프셋은 활성화 레코드의 시작지점으로 부터(매개변수의 개수 + 2)의 위치로 부터 순서대로 할당

환경 포인터(environment pointer OR EP)

- 현재 실행중인 부프로그램의 활성화 레코드 사례의 기준 주소를 가리킨다.
- 부프로그램 호출시, 현재의 EP는 다른 실행 상태와 함께 새로운 ARI에 저장되고, EP는 새로운 ARI의 기준 주소를 가리키도록 설정
- 부프로그램 복귀시, 실행 종료된 부프로그램의 ARI로부터 복구
- EP는 레지스터와 같은 고정된 위치에 저장

